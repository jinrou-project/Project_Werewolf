<html>
<head>
    <meta charset="UTF-8">
    <title>JINROU</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
</head>
<body>
	<h1>JINROU</h1>
    <div id="num"></div>
    <div id="loginForm">
        <input type ="text" id="name_input" autofocus onKeyPress="enterName();">
        <button onclick="entry();">入室</button><br>
    </div>

	<div id="nameArea"></div>
    <div id="formArea"></div>
    <div id="msg"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript">

    var myName;
    //エンターキーをおした時の操作
    function enterName(){
    	if(window.event.keyCode == 13){
    		entry();
    	}
    }
    function enterMsg(){
    	if(window.event.keyCode == 13){
    		publishMessage();
    	}
    }
    //入室時の処理
    function entry(){
        myName = $('#name_input').val();

        //var domForm = document.getElementById('formArea');
        var domForm = $('#formArea').get(0);
        domForm.innerHTML = '<input type="text" id="msg_input" style="width:200px;" autofocus onKeyPress="enterMsg();"><button onclick="publishMessage();">語る</button>';
        login(myName);
        //var lf = document.getElementById('loginForm');
        var lf = $('#loginForm').get(0);
        //名前入力欄削除
        while(lf.firstChild){
            lf.removeChild(lf.firstChild);
        }
        //var nameArea = document.getElementById('nameArea');
        var nameArea = $('#nameArea').get(0);
        //var domName = document.createElement('p');
        var domName = $('<p>').get(0);
        domName.innerHTML = 'ようこそ' + myName + 'さん';
        nameArea.appendChild(domName);
        //socketio.emit("entry", domName);;
        socketio.emit("line",null);
    }


    // 1.イベントとコールバックの定義
    var socketio = io.connect('http://localhost:8080');
    var num;

    socketio.on("line", function(data){
    	data.forEach(addMessage);
    });

    socketio.on("connected", function(name) {});
    socketio.on("publish", function (data) { addMessage(data.value); });
    socketio.on("disconnect", function () {});
    socketio.on("connNum", function (data) {
        console.log(data);
        num = data.toString();
        //document.getElementById("num").innerHTML = num;       
        $('num').innerHTML = num;
    });

    // 2.イベントに絡ませる関数の定義
    function start(name) {
        socketio.emit("connected", name);
    }

    function publishMessage() {
        //var textInput = document.getElementById('msg_input');
        var textInput = $('#msg_input').get(0);
        var msg = "[" + myName + "] " + textInput.value;
        socketio.emit("publish", {value: msg});
        textInput.value = '';
    }

    function addMessage (msg) {
        // var msgArea = document.getElementById("msg");
        var msgArea = $('#msg').get(0);
        // var domMsg = document.createElement('div');
        var domMsg = $('<div>').get(0);
        domMsg.innerHTML = new Date().toLocaleTimeString() + ' ' + msg;
        msgArea.insertBefore(domMsg,msgArea.firstChild);
    }

    // 3.開始処理
    function login(name){
        var myName = name + "さん";
        //addMessage("貴方は" + name + "として入室しました");
        start(myName);
    }
    </script>
</body>
</html>